{% extends "admin/change_form.html" %}
{% load static %}

{% block after_related_objects %}
  {% if image_paths %}
    <div style="margin: 20px 0;">
      <div id="timelapse-container" style="max-width: 500px;">
        <div style="text-align: left; margin-bottom: 10px;">
          <h3>Original image</h3>
          <img id="original-image" src="" style="width: 100%; border: 1px solid #ccc;" />
        </div>
        <h3>Watermarked image</h3>
        <div style="text-align: left; margin-bottom: 10px;">
          <img id="watermarked-image" src="" style="width: 100%; border: 1px solid #ccc;" />
          
        </div>
        <div style="text-align: left; margin-bottom: 10px;">
          <h3>Timelapse</h3>
          <img id="timelapse-image" src="" style="width: 100%; border: 1px solid #ccc;" />
        </div>
        
        <script>
          const cameraId = "{{ self.id }}";
          const imagePath = "{{ image_paths.0 }}";
          const apiUrl = `/api/webcams/${cameraId}/timelapse/`;

          fetch(apiUrl)
          .then(response => response.json())
          .then(data => {
            document.getElementById("timelapse-image").src = data[0];
          })
          .catch(error => console.error("Failed to fetch timelapse:", error));
        </script>

        <div style="margin-top: 10px; text-align: center;">
          <button type="button" id="prev-btn">⏮️</button>
          <button type="button" id="play-pause-btn">▶️</button>
          <button type="button" id="next-btn">⏭️</button>
          <br /><br />
          <input type="range" id="replay-slider" min="0" max="{{ image_paths|length|add:"-1" }}" value="0" style="width: 80%;">
          <br />
          <span id="replay-index">1</span> / {{ image_paths|length }}
        </div>
      </div>
    </div>

    <div style="margin-top: 20px;">
      <div style="margin: 20px 0; border: 1px solid #ccc; padding: 15px; border-radius: 5px; max-width: 400px;">
        <h3>Select Date & Time Range</h3>

        <label style="display: block; margin-bottom: 8px;">
          <input type="radio" name="date-option" value="all" checked>
          All Available Dates
        </label>

        <label style="display: block; margin-bottom: 8px;">
          <input type="radio" name="date-option" value="custom">
          Custom Date & Time Range
        </label>

        <div id="date-range-inputs" style="margin-left: 20px; display: none;">
          <div style="display: grid; grid-template-columns: 50px auto; align-items: center; gap: 8px; margin-bottom: 10px;">
            <label for="date-from" style="text-align: right;">From:</label>
            <div>
              <input type="date" id="date-from" value="{{ default_start_date|default:'' }}">
              <input type="time" id="time-from" value="00:00">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 50px auto; align-items: center; gap: 8px;">
            <label for="date-to" style="text-align: right;">To:</label>
            <div>
              <input type="date" id="date-to" value="{{ default_end_date|default:'' }}">
              <input type="time" id="time-to" value="23:59">
            </div>
          </div>
        </div>

        <div style="margin-top: 15px;">
          <button type="button" id="download-btn">Download</button>
        </div>
      </div>
    </div>

    <script id="image-paths-json" type="application/json">
      {{ image_paths_json|safe }}
    </script>

    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function () {
        const imagePaths = JSON.parse(document.getElementById("image-paths-json").textContent);
        const imgElem = document.getElementById("timelapse-image");
        const imgElemOriginal = document.getElementById("original-image");
        const imgElemWatermarked = document.getElementById("watermarked-image");
        const indexElem = document.getElementById("replay-index");
        const sliderElem = document.getElementById("replay-slider");
        const playPauseBtn = document.getElementById("play-pause-btn");
        const nextBtn = document.getElementById("next-btn");
        const prevBtn = document.getElementById("prev-btn");

        const radios = document.querySelectorAll("input[name='date-option']");
        const dateInputs = document.getElementById("date-range-inputs");
        const downloadBtn = document.getElementById("download-btn");

        let currentIndex = 0;
        let autoplay = false;
        let autoplayInterval;

        async function downloadImage(from, to, timeFrom, timeTo) {
          let apiUrl = imagePaths[imagePaths.length - 1];
          apiUrl = apiUrl.replace(/\/\d{14}\/timelapse\//, "/download/");
          // If from/to provided, append them as query params
          const params = new URLSearchParams();
          if (from) params.append("from", from);
          if (to) params.append("to", to);
          if (timeFrom) params.append("time_from", timeFrom);
          if (timeTo) params.append("time_to", timeTo);

          if (params.toString()) {
            apiUrl += "?" + params.toString();
          }

          console.log("Download API URL:", apiUrl);
          const response = await fetch(apiUrl, {
            headers: {
              "Authorization": `Api-Key ${apiKey}`
            }
          });
          const blob = await response.blob();
          imgElemOriginal.src = URL.createObjectURL(blob);

          const url = imgElemOriginal.src;
          const a = document.createElement('a');
          a.href = url;
          a.download = 'images.zip'; // filename
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url); // cleanup
        }

        async function displayOriginalImage() {
          let apiUrl = imagePaths[imagePaths.length - 1];
          apiUrl = apiUrl.replace(/\/\d{14}\/timelapse\//, "/originalImage/");
          console.log("Original image URL:", apiUrl);
          const response = await fetch(apiUrl, {
            headers: {
              "Authorization": `Api-Key ${apiKey}`
            }
          });
          const blob = await response.blob();
          imgElemOriginal.src = URL.createObjectURL(blob);
        }

        async function displayWatermarkedImage() {
          const apiUrl = imagePaths[imagePaths.length - 1];
          const response = await fetch(apiUrl, {
            headers: {
              "Authorization": `Api-Key ${apiKey}`
            }
          });
          const blob = await response.blob();
          imgElemWatermarked.src = URL.createObjectURL(blob);
        }

        function updateImage() {
          imgElem.src = imagePaths[currentIndex];
          indexElem.innerText = currentIndex + 1;
          sliderElem.value = currentIndex;
        }

        function nextImage() {
          if (currentIndex < imagePaths.length - 1) {
            currentIndex++;
            updateImage();
          } else {
            stopAutoplay(); // stop at the end
          }
        }

        function prevImage() {
          if (currentIndex > 0) {
            currentIndex--;
            updateImage();
          }
        }

        function startAutoplay() {
          autoplay = true;
          playPauseBtn.innerText = "⏸️";
          autoplayInterval = setInterval(nextImage, 200);
        }

        function stopAutoplay() {
          autoplay = false;
          playPauseBtn.innerText = "▶️";
          clearInterval(autoplayInterval);
        }

        function toggleAutoplay() {
          autoplay ? stopAutoplay() : startAutoplay();
        }

        nextBtn.addEventListener("click", nextImage);
        prevBtn.addEventListener("click", prevImage);
        playPauseBtn.addEventListener("click", toggleAutoplay);
        sliderElem.addEventListener("input", function () {
          currentIndex = parseInt(this.value, 10);
          updateImage();
        });

        radios.forEach(r => {
          r.addEventListener("change", () => {
            dateInputs.style.display = (r.value === "custom" && r.checked) ? "block" : "none";
          });
        });

        downloadBtn.addEventListener("click", () => {
          const option = document.querySelector("input[name='date-option']:checked").value;
          if (option === "all") {
            console.log("Download all available images");
            downloadImage();
          } else {
            const from = document.getElementById("date-from").value;
            const to = document.getElementById("date-to").value;
            const timeFrom = document.getElementById("time-from").value;
            const timeTo = document.getElementById("time-to").value;
            console.log("Download images from", from, "to", to, "time from", timeFrom, "to", timeTo);
            downloadImage(from, to, timeFrom, timeTo);
          }
        });

        updateImage();
        displayWatermarkedImage();
        displayOriginalImage();
      });
    </script>
  {% endif %}
{% endblock %}
