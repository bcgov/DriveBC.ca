{% extends "admin/change_form.html" %}
{% load static %}

{% block after_related_objects %}
  {% if image_paths %}
    <div style="margin: 20px 0;">
      <div id="timelapse-container" style="max-width: 500px;">
        <div style="text-align: left; margin-bottom: 10px;">
          <h3>Original image</h3>
          <img id="original-image" src="" style="width: 100%; border: 1px solid #ccc;" />
        </div>
        <h3>Watermarked image</h3>
        <div style="text-align: left; margin-bottom: 10px;">
          <img id="watermarked-image" src="" style="width: 100%; border: 1px solid #ccc;" />
          
        </div>
        <div style="text-align: left; margin-bottom: 10px;">
          <h3>Timelapse</h3>
          <img id="timelapse-image" src="" style="width: 100%; border: 1px solid #ccc;" />
        </div>
        
        <script>
          const cameraId = "{{ self.id }}";
          const imagePath = "{{ image_paths.0 }}";
          const apiUrl = `/api/webcams/${cameraId}/timelapse/`;
          const apiKey = "{{ api_key|escapejs }}";

          fetch(apiUrl, {
            headers: {
              "Authorization": `Api-Key ${apiKey}`
            }
          })
          .then(response => response.json())
          .then(data => {
            document.getElementById("timelapse-image").src = data[0];
          })
          .catch(error => console.error("Failed to fetch timelapse:", error));
        </script>

        <div style="margin-top: 10px; text-align: center;">
          <button type="button" id="prev-btn">⏮️</button>
          <button type="button" id="play-pause-btn">▶️</button>
          <button type="button" id="next-btn">⏭️</button>
          <br /><br />
          <input type="range" id="replay-slider" min="0" max="{{ image_paths|length|add:"-1" }}" value="0" style="width: 80%;">
          <br />
          <span id="replay-index">1</span> / {{ image_paths|length }}
        </div>
      </div>
    </div>

    <script id="image-paths-json" type="application/json">
      {{ image_paths_json|safe }}
    </script>

    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function () {
        const imagePaths = JSON.parse(document.getElementById("image-paths-json").textContent);
        const imgElem = document.getElementById("timelapse-image");
        const imgElemOriginal = document.getElementById("original-image");
        const imgElemWatermarked = document.getElementById("watermarked-image");
        const indexElem = document.getElementById("replay-index");
        const sliderElem = document.getElementById("replay-slider");
        const playPauseBtn = document.getElementById("play-pause-btn");
        const nextBtn = document.getElementById("next-btn");
        const prevBtn = document.getElementById("prev-btn");

        let currentIndex = 0;
        let autoplay = false;
        let autoplayInterval;

        async function displayOriginalImage() {
          let apiUrl = imagePaths[imagePaths.length - 1];
          apiUrl = apiUrl.replace(/\/\d{14}\/timelapse\//, "/originalImage/");
          console.log("Original image URL:", apiUrl);
          const response = await fetch(apiUrl, {
            headers: {
              "Authorization": `Api-Key ${apiKey}`
            }
          });
          const blob = await response.blob();
          imgElemOriginal.src = URL.createObjectURL(blob);
        }

        async function displayWatermarkedImage() {
          const apiUrl = imagePaths[imagePaths.length - 1];
          const response = await fetch(apiUrl, {
            headers: {
              "Authorization": `Api-Key ${apiKey}`
            }
          });
          const blob = await response.blob();
          imgElemWatermarked.src = URL.createObjectURL(blob);
        }

        async function updateImage() {
          const apiUrl = imagePaths[currentIndex];
          const response = await fetch(apiUrl, {
            headers: {
              "Authorization": `Api-Key ${apiKey}`
            }
          });
          const blob = await response.blob();
          imgElem.src = URL.createObjectURL(blob);

          indexElem.innerText = currentIndex + 1;
          sliderElem.value = currentIndex;
        }

        function nextImage() {
          if (currentIndex < imagePaths.length - 1) {
            currentIndex++;
            updateImage();
          } else {
            stopAutoplay(); // stop at the end
          }
        }

        function prevImage() {
          if (currentIndex > 0) {
            currentIndex--;
            updateImage();
          }
        }

        function startAutoplay() {
          autoplay = true;
          playPauseBtn.innerText = "⏸️";
          autoplayInterval = setInterval(nextImage, 200);
        }

        function stopAutoplay() {
          autoplay = false;
          playPauseBtn.innerText = "▶️";
          clearInterval(autoplayInterval);
        }

        function toggleAutoplay() {
          autoplay ? stopAutoplay() : startAutoplay();
        }

        nextBtn.addEventListener("click", nextImage);
        prevBtn.addEventListener("click", prevImage);
        playPauseBtn.addEventListener("click", toggleAutoplay);
        sliderElem.addEventListener("input", function () {
          currentIndex = parseInt(this.value, 10);
          updateImage();
        });

        updateImage();
        displayWatermarkedImage();
        displayOriginalImage();
      });
    </script>
  {% endif %}
{% endblock %}
