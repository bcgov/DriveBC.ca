{% extends "admin/change_form.html" %}
{% load static %}

{% block after_related_objects %}
  {% if image_paths %}
    <div style="margin: 20px 0;">
      <h3>Timelapse</h3>
      <div id="timelapse-container" style="max-width: 500px;">
  
        <img id="replay-image" src="" style="width: 100%; border: 1px solid #ccc;" />

        <script>
          // Construct the API endpoint URL dynamically if needed
          const cameraId = "{{ self.id }}";
          const imagePath = "{{ image_paths.0 }}";
          const apiUrl = `/api/webcams/${cameraId}/timelapse/`;

          fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
              // data.url contains the presigned URL
              document.getElementById("replay-image").src = data.url;
            })
            .catch(error => {
              console.error("Failed to fetch image URL:", error);
            });
        </script>
        
        
        
        
        
        <div style="margin-top: 10px; text-align: center;">
          <button type="button" id="prev-btn">⏮️</button>
          <button type="button" id="play-pause-btn">▶️</button>
          <button type="button" id="next-btn">⏭️</button>
          <br /><br />
          <input type="range" id="replay-slider" min="0" max="{{ image_paths|length|add:"-1" }}" value="0" style="width: 80%;">
          <br />
          <span id="replay-index">1</span> / {{ image_paths|length }}
        </div>
      </div>
    </div>

    <script id="image-paths-json" type="application/json">
      {{ image_paths_json|safe }}
    </script>

    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function () {
        const imagePaths = JSON.parse(document.getElementById("image-paths-json").textContent);
        const imgElem = document.getElementById("replay-image");
        const indexElem = document.getElementById("replay-index");
        const sliderElem = document.getElementById("replay-slider");
        const playPauseBtn = document.getElementById("play-pause-btn");
        const nextBtn = document.getElementById("next-btn");
        const prevBtn = document.getElementById("prev-btn");

        let currentIndex = 0;
        let autoplay = false;
        let autoplayInterval;

        function updateImage() {
          imgElem.src = imagePaths[currentIndex];
          indexElem.innerText = currentIndex + 1;
          sliderElem.value = currentIndex;
        }

        function nextImage() {
          if (currentIndex < imagePaths.length - 1) {
            currentIndex++;
            updateImage();
          } else {
            stopAutoplay(); // stop at the end
          }
        }

        function prevImage() {
          if (currentIndex > 0) {
            currentIndex--;
            updateImage();
          }
        }

        function startAutoplay() {
          autoplay = true;
          playPauseBtn.innerText = "⏸️";
          autoplayInterval = setInterval(nextImage, 200);
        }

        function stopAutoplay() {
          autoplay = false;
          playPauseBtn.innerText = "▶️";
          clearInterval(autoplayInterval);
        }

        function toggleAutoplay() {
          autoplay ? stopAutoplay() : startAutoplay();
        }

        nextBtn.addEventListener("click", nextImage);
        prevBtn.addEventListener("click", prevImage);
        playPauseBtn.addEventListener("click", toggleAutoplay);
        sliderElem.addEventListener("input", function () {
          currentIndex = parseInt(this.value, 10);
          updateImage();
        });

        updateImage();
      });
    </script>
  {% endif %}
{% endblock %}
