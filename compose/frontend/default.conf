client_body_temp_path /tmp/client_temp;
proxy_temp_path       /tmp/proxy_temp;
fastcgi_temp_path     /tmp/fastcgi_temp;
uwsgi_temp_path       /tmp/uwsgi_temp;
scgi_temp_path        /tmp/scgi_temp;
proxy_cache_path      /tmp/cache/nginx keys_zone=cache:50m;
proxy_cache cache;
proxy_cache_key "$scheme$request_method$host$uri$is_args$args$normalized_encoding$client_format";

brotli on;
brotli_static on;
brotli_comp_level 6;
brotli_types
    text/css
    text/plain
    text/javascript
    application/javascript
    application/json
    image/svg+xml
    image/x-icon;
gzip on;
gzip_vary on; 
gzip_min_length 1024; 
gzip_proxied any; 
gzip_types
	text/css
	text/plain
	text/javascript
	application/javascript
	application/json
	application/x-javascript
	application/xml
	application/xml+rss
	application/xhtml+xml
	application/x-font-ttf
	application/x-font-opentype
	application/vnd.ms-fontobject
	image/svg+xml
	image/x-icon
	application/rss+xml
	application/atom_xml;
    gzip_disable "MSIE [1-6]\.";

map $http_accept $client_format {
    default       "json";
    "~text/html"  "html";
}

map $http_accept_encoding $normalized_encoding {
    default         "";
    "~*br"          "br";
    "~*gzip"        "gzip";
}

#Logging Settings
map $time_iso8601 $year {
    default             'year';
    '~^(?<yyyy>\d{4})-'     $yyyy;
}
map $time_iso8601 $month {
    default             'month';
    '~^\d{4}-(?<mm>\d{2})-'     $mm;
}
map $time_iso8601 $day {
    default             'day';
    '~^\d{4}-\d{2}-(?<dd>\d{2})'    $dd;
}
map $time_iso8601 $hour {
    default             'hour';
    '~^\d{4}-\d{2}-\d{2}T(?<hh>\d{2})'    $hh;
}

map $time_iso8601 $formatted_date {
    default                                                                 'date-not-found';
    '~^(?<year>\d{4})-(?<month>\d{2})-(?<day>\d{2})T(?<hour>\d{2})'         $year$month$day$hour;
}

log_format drivebc '$remote_addr - $remote_user [$time_local] "$host" '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" $upstream_cache_status "$sent_http_content_type" $request_time';

error_log /var/log/nginx/error.log;

open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2;

# Trust OpenShift Router IP range
set_real_ip_from 10.0.0.0/8; 
real_ip_header X-Forwarded-For;

# --- CONSOLIDATED REDIRECTS BLOCK ---
server {
    listen 3000;
    listen [::]:3000;

    # All hostnames that should redirect to www.drivebc.ca
    server_name drivebc.ca
                m.drivebc.ca mobile.drivebc.ca
                drivebc.com www.drivebc.com
                drivebc.info www.drivebc.info
                drivebc.net www.drivebc.net
                drivebc.org www.drivebc.org;
    root        /usr/share/nginx/html;
    access_log /logs/$hostname-$formatted_date-access.log drivebc;
    server_tokens off;
    # The action for ALL requests matching this server block: redirect.
    return 301 https://www.drivebc.ca$request_uri;
}

server {
    listen       3000 default_server;
    listen  [::]:3000 default_server;
    server_name  www.drivebc.ca; 
    root         /usr/share/nginx/html;
    access_log /logs/$hostname-$formatted_date-access.log drivebc;
    server_tokens off;
    include /etc/nginx/conf.d/blocked_ips.conf;
    include /etc/nginx/conf.d/security_headers.conf;

    location ~ ^/(drivebc-admin|drivebc-cms|django-static|healthcheck) {
        allow 142.34.53.0/24;
        allow 142.22.0.0/15;
        allow 142.24.0.0/13;
        allow 142.32.0.0/13;
        allow 208.181.128.46/32; #OXD VPN
        allow 127.0.0.1;
        deny all; 
        
        proxy_ssl_server_name on;
        proxy_pass http://{ENVIRONMENT}-django;
        proxy_connect_timeout 10s;
        proxy_set_header Host $host;
        include /etc/nginx/conf.d/security_headers_admin.conf;
    }

    location ~* \.(?:css|js|woff|woff2|ttf|eot|svg|png|jpe?g|gif|ico)$ {
        expires 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
        brotli_static on;
        gzip_static on;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location = /index.html {
        add_header Cache-Control "no-cache, must-revalidate, max-age=0";
        expires off;
        brotli_static on;
        gzip_static on;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location / {
        index  index.html index.htm;
        try_files $uri $uri/ /index.html;
        brotli_static on;
        gzip_static on;
    }

    location ^~ /images/ {
        alias /app/images/webcams/;
        try_files $uri =404;
        expires    modified +1s;
        add_header Last-Modified "";
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location ^~ /images/replaytheday/ {
        alias /app/images/webcams/processed/;
        try_files $uri =404;
        include /etc/nginx/conf.d/security_headers.conf;
    }
    # Blocking external access to original images and timelapse endpoints. Must be accessed through API Gateway
    location ^~ /images/originals/ {
        deny all;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location ~ ^/api/webcams/\d+/timelapse/ {
        deny all;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location ~ ^/api/webcams/\d+/originalImage/ {
        deny all;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    # Caching data from the API
    location /api/ {
        # Block RSS format requests (at this time) to mitigate load on the backend DBC22-5534
        if ($arg_format = "rss") {
            return 404;
        }
        proxy_ignore_headers Vary;
        proxy_hide_header Vary;
        proxy_hide_header Set-Cookie;
        proxy_hide_header X-Content-Type-Options;
        proxy_hide_header X-Frame-Options;
        add_header Vary "Accept-Encoding" always;
        add_header X-Proxy-Cache $upstream_cache_status;
        proxy_ssl_server_name on;
        proxy_pass http://{ENVIRONMENT}-django;
        proxy_connect_timeout 5s;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        proxy_cache_lock_age 10s;
        proxy_cache_lock_timeout 10s;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_valid 200 30s;
        proxy_cache_valid 404 1s;
        proxy_cache_bypass $http_cachebypass;
        proxy_set_header Host $host;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location ^~ /api/users/ {
        proxy_ssl_server_name on;
        proxy_pass http://{ENVIRONMENT}-django;
        proxy_connect_timeout 10s;
        proxy_set_header Host $host;
        proxy_cache off;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location ^~ /api/session {
        proxy_ssl_server_name on;
        proxy_pass http://{ENVIRONMENT}-django;
        proxy_connect_timeout 10s;
        proxy_set_header Host $host;
        proxy_cache off;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location ^~ /accounts/ {
        proxy_ssl_server_name on;
        proxy_pass http://{ENVIRONMENT}-django;
        proxy_connect_timeout 10s;
        proxy_set_header Host $host;
        proxy_cache off;
        include /etc/nginx/conf.d/security_headers.conf;
    }

    location ^~ /django-media/ {
        proxy_ssl_server_name on;
        proxy_pass http://{ENVIRONMENT}-django;
        proxy_connect_timeout 5s;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        proxy_cache_lock_age 10s;
        proxy_cache_lock_timeout 10s;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_valid 200 1d;
        add_header X-Proxy-Cache $upstream_cache_status;
        proxy_cache_bypass $http_cachebypass;
        include /etc/nginx/conf.d/security_headers.conf;
    }
    location ^~ /healthz {
        access_log off;
        add_header 'Content-Type' 'text/plain';
    	allow 127.0.0.1;
    	deny all;
        return 200 "healthy\n";
    }

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # 301 redirects for legacy backwards-compatibility
    include /etc/nginx/legacy_redirects.conf;
}